---
import BaseLayout from "@/layouts/BaseLayout.astro";
import MarkdownRenderer from "@/components/MarkdownRenderer";
import { fetchEnvironmentalImpact, fetchPaperById } from "@/lib/papersApi";
import { toPersonSchemaAuthors } from "@/utils/authors";
import { formatCo2, formatCurrency, formatEnergy, formatTokens, tokensToCo2g, tokensToEnergyMWh } from "@/utils/ecoMetrics";

export const prerender = false;

const rawId = Astro.params.id;
const id = typeof rawId === "string" ? rawId : null;

const safeId = id ?? "unknown";
let paper = null;
try {
  paper = id ? await fetchPaperById({ origin: Astro.url.origin, id }) : null;
} catch (error) {
  console.error("Failed to load paper detail", error);
  paper = null;
}

let energyPerTokenWh = 0;
let co2PerWh = 0;
let impactLoadFailed = false;
try {
  const impact = await fetchEnvironmentalImpact({ origin: Astro.url.origin });
  energyPerTokenWh = impact.energyPerTokenWh;
  co2PerWh = impact.co2PerWh;
} catch (error) {
  impactLoadFailed = true;
  console.error("Failed to load environmental impact values", error);
}

if (!paper) {
  Astro.response.status = 404;
}

const isRejected = paper?.status === "rejected";
const siteUrl = (import.meta.env.SITE_URL as string | undefined)?.replace(/\/$/, "") ?? Astro.url.origin;
const canonicalUrl = `${siteUrl}/papers/${safeId}`;

const pageTitle = paper
  ? `${paper.title} | The Journal of AI Slop™`
  : "Paper Not Found | The Journal of AI Slop™";
const description = paper
  ? paper.content.replace(/[#*_`\[\]]/g, "").slice(0, 200).trim()
  : "This paper does not exist or is not publicly available.";

const reviewLabel = (decision: "publish_now" | "publish_after_edits" | "reject") => {
  if (decision === "publish_now") return "PUBLISH NOW";
  if (decision === "publish_after_edits") return "PUBLISH AFTER EDITS";
  return "REJECTED";
};

const totalTokensForDisplay = paper
  ? (paper.totalTokens ?? paper.reviewVotes?.reduce((sum, review) => sum + (review.totalTokens ?? 0), 0) ?? null)
  : null;
---

<BaseLayout title={pageTitle} description={description}>
  <Fragment slot="head">
    <link rel="canonical" href={canonicalUrl} />
    {isRejected && <meta name="robots" content="noindex,follow" />}
    {paper && (
      <>
        <meta name="author" content={paper.authors} />
        <meta name="keywords" content={paper.tags.join(", ")} />
        <meta property="og:title" content={paper.title} />
        <meta property="og:description" content={description} />
        <meta property="og:type" content="article" />
        <meta property="og:url" content={canonicalUrl} />
        <script
          type="application/ld+json"
          set:html={JSON.stringify({
            "@context": "https://schema.org",
            "@type": "ScholarlyArticle",
            headline: paper.title,
            author: toPersonSchemaAuthors(paper.authors),
            datePublished: new Date(paper.submittedAt).toISOString(),
            keywords: paper.tags,
            description,
            identifier: paper._id,
          })}
        />
      </>
    )}
  </Fragment>

  <main class="min-h-screen px-3 py-10 text-[color:var(--ink)] sm:px-4">
    <div class="mx-auto w-full max-w-[1040px] space-y-8">
      <a
        href="/papers"
        class="text-[0.65rem] font-semibold uppercase tracking-[0.25em] text-[color:var(--ink-soft)] transition hover:text-[color:var(--accent-blue)] sm:text-xs sm:tracking-[0.35em]"
      >
        ← Back to Papers
      </a>

      {!paper ? (
        <section class="rounded-[28px] border border-[color:var(--coffee-light)] bg-[color:var(--paper)]/95 p-6 text-center text-sm text-[color:var(--accent-red)] shadow-[0_15px_35px_rgba(35,24,21,0.12)]">
          Paper not found.
        </section>
      ) : (
        <>
          <article class="space-y-6 rounded-[26px] border border-[color:var(--coffee-light)] bg-[color:var(--paper)]/90 p-5 shadow-[0_20px_40px_rgba(35,24,21,0.12)] sm:rounded-[32px] sm:p-8">
            <div class="flex flex-col gap-2 text-center sm:text-left">
              <p class="text-[0.65rem] uppercase tracking-[0.3em] text-[color:var(--ink-soft)] sm:text-xs sm:tracking-[0.4em]">Research Note</p>
              <h1 class="paper-title-glow wobbly-underline text-[clamp(2rem,5vw,3rem)] font-semibold leading-tight text-[color:var(--ink)]">{paper.title}</h1>
            </div>
            <div class="flex flex-wrap items-baseline gap-3 text-center text-sm text-[color:var(--ink-soft)] sm:flex-row sm:text-left">
              <p class="italic">by {paper.authors}</p>
              <span class="mx-auto rounded-full border border-[color:var(--coffee)] px-3 py-1 text-[0.55rem] font-semibold uppercase tracking-[0.3em] text-[color:var(--coffee)] sm:mx-0 sm:text-[0.6rem] sm:tracking-[0.4em]">
                {paper.status === "accepted" ? "PUBLISHED" : "REJECTED"}
              </span>
            </div>
            <div class="flex flex-wrap gap-2 text-[0.6rem] text-[color:var(--coffee)] sm:text-[0.65rem]">
              {paper.tags.map((tag) => (
                <span class="rounded-full border border-[color:var(--coffee)] bg-[color:var(--paper)]/80 px-3 py-1">{tag}</span>
              ))}
            </div>
            {paper.slopIdentifier && (
              <p class="text-[0.7rem] text-[color:var(--coffee)]">
                Slop ID:
                <a
                  href={paper.slopIdentifier.fromLocalJournal ? `/${paper.slopIdentifier.link}` : paper.slopIdentifier.link}
                  class="ml-1 font-mono underline decoration-[color:var(--coffee)] text-[color:var(--accent-blue)]"
                >
                  {paper.slopIdentifier.slopId}
                </a>
              </p>
            )}
            <div class="grid grid-cols-1 gap-1 text-[0.7rem] text-[color:var(--ink-soft)] sm:grid-cols-2">
              <p class="non-eco-only">Review cost: {paper.totalReviewCost != null ? formatCurrency(paper.totalReviewCost, 6) : "Calculating..."}</p>
              <p class="non-eco-only">Tokens: {totalTokensForDisplay != null ? formatTokens(totalTokensForDisplay) : "Calculating..."}</p>
              <p class="eco-only">Energy: {impactLoadFailed ? "Unavailable" : (totalTokensForDisplay != null && energyPerTokenWh > 0 ? formatEnergy(tokensToEnergyMWh(totalTokensForDisplay, energyPerTokenWh)) : "Calculating energy...")}</p>
              <p class="eco-only">CO2: {impactLoadFailed ? "Unavailable" : (totalTokensForDisplay != null && energyPerTokenWh > 0 && co2PerWh > 0 ? formatCo2(tokensToCo2g(totalTokensForDisplay, energyPerTokenWh, co2PerWh)) : "Calculating impact...")}</p>
            </div>
            <p class="text-[0.7rem] text-[color:var(--ink-soft)]">Submitted on {new Date(paper.submittedAt).toLocaleDateString("en-GB")}</p>
            <div class="watermarked-paper rounded-[24px] border border-[color:var(--coffee-light)] bg-[color:var(--paper)]/80 px-4 py-5 text-[color:var(--ink-soft)] shadow-[0_15px_35px_rgba(35,24,21,0.08)] sm:px-6">
              <MarkdownRenderer content={paper.content} className="text-sm leading-relaxed" />
              <p class="mt-4 text-[0.65rem] uppercase tracking-[0.3em] text-[color:var(--ink-soft)]">
                Licensed under
                <a href="/licensing#paper" class="ml-1 text-[color:var(--accent-blue)] underline">CC BY-NC-SA 4.0</a>
              </p>
            </div>
          </article>

          {paper.editorComment && (
            <section class="space-y-3 rounded-[26px] border border-[color:var(--coffee-light)] bg-[color:var(--paper)]/90 p-4 shadow-[0_15px_35px_rgba(35,24,21,0.12)] sm:rounded-[32px] sm:p-5">
              <p class="text-[0.65rem] uppercase tracking-[0.3em] text-[color:var(--ink-soft)] sm:text-xs sm:tracking-[0.45em]">Editors' Comment</p>
              <p class="text-sm italic text-[color:var(--ink-soft)]">“{paper.editorComment.comment}”</p>
              <p class="text-[0.65rem] text-[color:var(--ink-soft)]">Added on {new Date(paper.editorComment.createdAt).toLocaleDateString("en-GB")}</p>
            </section>
          )}

          <section class="space-y-6 rounded-[26px] border border-[color:var(--coffee-light)] bg-[color:var(--paper)]/90 p-4 shadow-[0_15px_35px_rgba(35,24,21,0.12)] sm:rounded-[32px] sm:p-5">
            <div class="flex flex-col gap-2 text-center sm:flex-row sm:items-center sm:justify-between sm:text-left">
              <div>
                <p class="text-[0.65rem] uppercase tracking-[0.3em] text-[color:var(--ink-soft)] sm:text-xs sm:tracking-[0.45em]">Peer Reviews (By Bots)</p>
                <h2 class="text-[clamp(1.5rem,4vw,2.25rem)] font-semibold text-[color:var(--ink)]">Verdicts</h2>
              </div>
              <p class="text-[0.6rem] uppercase tracking-[0.3em] text-[color:var(--coffee)] sm:text-[0.65rem] sm:tracking-[0.4em]">Certified Unrigor</p>
            </div>

            {paper.reviewVotes && paper.reviewVotes.length > 0 ? (
              <div class="space-y-4">
                {paper.reviewVotes.map((review, idx) => (
                  <div class="rounded-[24px] border border-[color:var(--coffee-light)] bg-[color:var(--paper)]/90 p-4 shadow-[0_10px_25px_rgba(35,24,21,0.08)] sm:rounded-[28px] sm:p-5">
                    <div class="flex flex-col gap-1 text-center sm:flex-row sm:items-center sm:justify-between sm:text-left">
                      <p class="text-[0.65rem] font-semibold uppercase tracking-[0.3em] text-[color:var(--ink-soft)] sm:text-xs sm:tracking-[0.45em]">Reviewer {idx + 1}</p>
                      <span class="text-[0.6rem] font-semibold uppercase tracking-[0.3em] text-[color:var(--ink)] sm:text-[0.65rem] sm:tracking-[0.4em]">
                        {reviewLabel(review.decision)}
                      </span>
                    </div>
                    <p class="mt-2 text-sm italic text-[color:var(--ink-soft)]">“{review.reasoning}”</p>
                    <div class="mt-3 flex flex-wrap justify-between gap-3 text-[0.6rem] font-mono text-[color:var(--ink-soft)] sm:text-[0.65rem]">
                      <span>Model: {review.agentId}</span>
                      <span class="non-eco-only">Cost: {formatCurrency(review.cost, 6)}</span>
                      <span class="non-eco-only">Tokens: {formatTokens(review.totalTokens ?? 0)}</span>
                      <span class="eco-only">Energy: {impactLoadFailed ? "Unavailable" : (energyPerTokenWh > 0 ? formatEnergy(tokensToEnergyMWh(review.totalTokens ?? 0, energyPerTokenWh)) : "Calculating energy...")}</span>
                      <span class="eco-only">CO2: {impactLoadFailed ? "Unavailable" : (energyPerTokenWh > 0 && co2PerWh > 0 ? formatCo2(tokensToCo2g(review.totalTokens ?? 0, energyPerTokenWh, co2PerWh)) : "Calculating impact...")}</span>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <p class="text-sm italic text-[color:var(--ink-soft)]">No review details are available for this paper.</p>
            )}
          </section>
        </>
      )}
    </div>
  </main>
</BaseLayout>
